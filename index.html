<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ò–≥—Ä–∞ "–î—É—Ä–∞–∫" –Ω–∞ PyScript (–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª)</title>
  
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º PyScript -->
  <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
  <script defer src="https://pyscript.net/alpha/pyscript.js"></script>

  <!-- –ù–µ–±–æ–ª—å—à–æ–π CSS –¥–ª—è —Å—Ç–∏–ª—è -->
  <style>
    body {
      margin: 0; 
      padding: 0;
      font-family: Arial, sans-serif;
      background: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background: #3f51b5;
      color: white;
      width: 100%;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    .container {
      background: white;
      width: 600px;
      max-width: 90%;
      margin: 1rem;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    button {
      background: #3f51b5;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
    }
    button:hover {
      background: #32408f;
    }
    /* –ü—Ä—è—á–µ–º —ç—Ç–∏ –±–ª–æ–∫–∏ –¥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ –∫–æ–¥–µ */
    #menu-container, #game-container, #end-container {
      display: none;
    }
    label {
      margin-right: 1rem;
    }
    #log-area {
      white-space: pre-wrap;
      background: #f8f8f8;
      padding: 1rem;
      min-height: 200px;
      margin-top: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 0.9rem;
    }
    .section-title {
      font-weight: bold;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

<header>
  <h1>–ò–≥—Ä–∞ "–î—É—Ä–∞–∫" (–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª, PyScript)</h1>
</header>

<!-- –ë–õ–û–ö 1: –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
<div class="container" id="menu-container">
  <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
  <div>
    <label>
      –†–µ–∂–∏–º –∏–≥—Ä—ã:
      <select id="select_mode">
        <option value="classic">classic</option>
        <option value="podkidnoi">podkidnoi</option>
        <option value="perevodnoi">perevodnoi</option>
        <option value="jokers">jokers</option>
        <option value="all">all</option>
      </select>
    </label>
    <label>
      <input type="checkbox" id="cb_6plus" />
      –¢–æ–ª—å–∫–æ 6..A
    </label>
    <label>
      <input type="checkbox" id="cb_jokers" />
      –° –¥–∂–æ–∫–µ—Ä–∞–º–∏
    </label>
    <br />
    <label>
      –ö–æ–ª-–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (2..4):
      <input type="number" id="num_players" value="2" min="2" max="4" style="width:50px;" />
    </label>
  </div>
  <p>
    –í—Å–µ –∏–≥—Ä–æ–∫–∏, –∫—Ä–æ–º–µ –∏–≥—Ä–æ–∫–∞ 1, –±—É–¥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –ò–ò (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä).
    –ú–æ–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä –ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ –º–µ—Ö–∞–Ω–∏–∫–∏ –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã.
  </p>

  <!-- –í–º–µ—Å—Ç–æ addEventListener –∏—Å–ø–æ–ª—å–∑—É–µ–º py-click -->
  <button py-click="start_game">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
</div>

<!-- –ë–õ–û–ö 2: –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
<div class="container" id="game-container">
  <h2>–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!</h2>
  <p class="section-title">–ö–æ–∑—ã—Ä—å: <span id="span_trump_suit"></span></p>
  <p class="section-title">–•–æ–¥ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞:</p>
  <div>
    <!-- –¢–æ–∂–µ py-click -->
    <button py-click="do_next_round">–°–¥–µ–ª–∞—Ç—å —à–∞–≥ (–∞—Ç–∞–∫–∞/–∑–∞—â–∏—Ç–∞)</button>
  </div>
  <div class="section-title">–°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã:</div>
  <div id="log-area"></div>
  <button py-click="give_up">–í—ã–π—Ç–∏ –≤ –º–µ–Ω—é</button>
</div>

<!-- –ë–õ–û–ö 3: –û–∫–æ–Ω—á–∞–Ω–∏–µ –∏–≥—Ä—ã -->
<div class="container" id="end-container">
  <h2>–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
  <p id="end-message"></p>
  <button py-click="return_menu">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</button>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π PyScript-–∫–æ–¥: –ª–æ–≥–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º -->
<py-script>
#########################################################
#                –ü–û–õ–ù–ê–Ø –ú–ï–•–ê–ù–ò–ö–ê –ò–ì–†–´ "–î–£–†–ê–ö"
#         + –ü–æ—à–∞–≥–æ–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)
#         + –ò–ò (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–≥—Ä–æ–∫–∏ –∫—Ä–æ–º–µ –∏–≥—Ä–æ–∫–∞ 1)
#         + –û–∫–æ–Ω—á–∞–Ω–∏–µ –∏–≥—Ä—ã –∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –º–µ–Ω—é
#         + py-click –≤–º–µ—Å—Ç–æ addEventListener
#########################################################

import random
from js import document

# --- –†–µ–∂–∏–º—ã ---
MODE_CLASSIC    = "classic"
MODE_PODKIDNOI  = "podkidnoi"
MODE_PEREVODNOI = "perevodnoi"
MODE_JOKERS     = "jokers"
MODE_ALL        = "all"

# --- –ö–ª–∞—Å—Å—ã: Card, Deck, GameRules ---
class Card:
    def __init__(self, rank, suit, is_joker=False):
        self.rank = rank
        self.suit = suit
        self.is_joker = is_joker

    def __repr__(self):
        if self.is_joker:
            return f"[Joker: {self.rank}]"
        else:
            return f"[{self.rank} {self.suit}]"

class Deck:
    FULL_RANKS = [str(n) for n in range(2, 11)] + ["J", "Q", "K", "A"]
    SUITS = ["‚ô†", "‚ô•", "‚ô¶", "‚ô£", "‚≠ê", "üåô", "‚öú"]
    JOKERS = ["Joker-3", "Joker-4"]

    def __init__(self, mode=MODE_CLASSIC, ranks_from_6=False, with_jokers=False):
        self.mode = mode
        self.ranks_from_6 = ranks_from_6
        self.with_jokers = with_jokers
        self.cards = self._create_filtered_deck()

    def _create_filtered_deck(self):
        if self.ranks_from_6:
            possible_ranks = [r for r in self.FULL_RANKS if r not in ['2','3','4','5']]
        else:
            possible_ranks = self.FULL_RANKS[:]

        normal_cards = []
        for suit in self.SUITS:
            for rank in possible_ranks:
                normal_cards.append(Card(rank, suit, is_joker=False))

        joker_cards = []
        if self.with_jokers:
            for j in self.JOKERS:
                joker_cards.append(Card(rank=j, suit="JokerSuit", is_joker=True))

        return normal_cards + joker_cards

    def shuffle_deck(self):
        random.shuffle(self.cards)

    def draw_card(self):
        if self.cards:
            return self.cards.pop(0)
        return None

class GameRules:
    def __init__(self, mode=MODE_CLASSIC):
        self.mode = mode
        self.rank_order = ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]
        self.trump_suit = None

    def set_trump_suit(self, suit):
        self.trump_suit = suit

    def is_card_higher(self, card1, card2):
        # card1 –∑–∞—â–∏—â–∞–µ—Ç—Å—è
        if card1.is_joker:
            if self.mode in [MODE_JOKERS, MODE_ALL]:
                if card2.is_joker:
                    return False
                else:
                    return True
            else:
                return False

        if card2.is_joker and self.mode in [MODE_JOKERS, MODE_ALL]:
            return False

        c1_trump = (card1.suit == self.trump_suit)
        c2_trump = (card2.suit == self.trump_suit)

        if c1_trump and not c2_trump:
            return True
        if not c1_trump and c2_trump:
            return False

        if card1.suit == card2.suit:
            r1_index = self.rank_order.index(card1.rank) if card1.rank in self.rank_order else -1
            r2_index = self.rank_order.index(card2.rank) if card2.rank in self.rank_order else -1
            return r1_index > r2_index
        else:
            return False

    def check_defend(self, defending_card, attacking_card):
        return self.is_card_higher(defending_card, attacking_card)


# --- –ò–≥—Ä–æ–∫ (–ò–ò) ---
class AIPlayer:
    """
    –ü—Ä–æ—Å—Ç–æ–π –ò–ò: –ø—Ä–∏ –∞—Ç–∞–∫–µ - –±–µ—Ä—ë—Ç –ø–µ—Ä–≤—É—é –∫–∞—Ä—Ç—É,
                –ø—Ä–∏ –∑–∞—â–∏—Ç–µ - –∏—â–µ—Ç –ø–µ—Ä–≤—É—é, –∫–æ—Ç–æ—Ä–∞—è –±—å—ë—Ç –∞—Ç–∞–∫—É—é—â—É—é.
    """
    def __init__(self, player_id):
        self.player_id = player_id

    def choose_attack_card(self, cards):
        if not cards:
            return None, -1
        return cards[0], 0

    def choose_defend_card(self, cards, attack_card, rules):
        for i, c in enumerate(cards):
            if rules.check_defend(c, attack_card):
                return c, i
        return None, -1


class GameSession:
    """
    –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª "–î—É—Ä–∞–∫–∞" (—É–ø—Ä–æ—â—ë–Ω–Ω–æ) + –ø–æ—à–∞–≥–æ–≤—ã–π –º–µ—Ç–æ–¥ do_round() –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ö–æ–¥–∞.
    """
    def __init__(self, mode=MODE_CLASSIC, num_players=2, ranks_from_6=False, with_jokers=False):
        self.mode = mode
        self.num_players = num_players
        self.deck = Deck(mode, ranks_from_6, with_jokers)
        self.deck.shuffle_deck()
        self.rules = GameRules(mode)
        self.rules.set_trump_suit(random.choice(Deck.SUITS))

        self.players_hands = [[] for _ in range(num_players)]

        self.players = []
        for pid in range(num_players):
            self.players.append(AIPlayer(pid))

        # –†–∞–∑–¥–∞—ë–º –ø–æ 6 –∫–∞—Ä—Ç
        for p in range(num_players):
            for _ in range(6):
                c = self.deck.draw_card()
                if c:
                    self.players_hands[p].append(c)

        self.active_players = set(range(num_players))
        self.current_attacker = 0
        self.current_defender = (self.current_attacker + 1) % num_players if num_players > 1 else None

        self.log_messages = []
        self.log(f"–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å. –ö–æ–∑—ã—Ä—å: {self.rules.trump_suit}, –ò–≥—Ä–æ–∫–æ–≤: {num_players}")

    def log(self, txt):
        self.log_messages.append(txt)

    def get_log_text(self):
        return "\n".join(self.log_messages)

    def do_round(self):
        """
        –ü—Ä–æ–≤–æ–¥–∏–º –æ–¥–∏–Ω —Ö–æ–¥ (–∞—Ç–∞–∫–∞/–∑–∞—â–∏—Ç–∞).
        """
        if self.current_defender is None or self.current_defender not in self.active_players:
            self.log("–ù–µ—Ç –∑–∞—â–∏—Ç–Ω–∏–∫–∞ –∏–ª–∏ –æ–Ω –≤—ã—à–µ–ª.")
            return

        # –ï—Å–ª–∏ —É –∞—Ç–∞–∫—É—é—â–µ–≥–æ –Ω–µ—Ç –∫–∞—Ä—Ç
        if not self.players_hands[self.current_attacker]:
            self.log(f"–ò–≥—Ä–æ–∫ {self.current_attacker+1} –Ω–µ –º–æ–∂–µ—Ç –∞—Ç–∞–∫–æ–≤–∞—Ç—å (–Ω–µ—Ç –∫–∞—Ä—Ç).")
            self._choose_next_attacker()
            return

        atk_player = self.players[self.current_attacker]
        atk_card, atk_idx = atk_player.choose_attack_card(self.players_hands[self.current_attacker])
        if not atk_card:
            self.log(f"–ò–≥—Ä–æ–∫ {self.current_attacker+1} –ø–∞—Å—É–µ—Ç.")
            self._choose_next_attacker()
            return

        self.players_hands[self.current_attacker].pop(atk_idx)
        self.log(f"–ò–≥—Ä–æ–∫ {self.current_attacker+1} –∞—Ç–∞–∫—É–µ—Ç –∫–∞—Ä—Ç–æ–π {atk_card}")

        def_player = self.players[self.current_defender]
        def_card, def_idx = def_player.choose_defend_card(self.players_hands[self.current_defender], atk_card, self.rules)
        if not def_card:
            self.log(f"–ò–≥—Ä–æ–∫ {self.current_defender+1} –ù–ï –æ—Ç–±–∏–ª—Å—è –∏ –±–µ—Ä—ë—Ç –∫–∞—Ä—Ç—É {atk_card} –∫ —Å–µ–±–µ.")
            self.players_hands[self.current_defender].append(atk_card)
        else:
            self.players_hands[self.current_defender].pop(def_idx)
            if self.rules.check_defend(def_card, atk_card):
                self.log(f"–ò–≥—Ä–æ–∫ {self.current_defender+1} –æ—Ç–±–∏–ª—Å—è –∫–∞—Ä—Ç–æ–π {def_card}. –ö–∞—Ä—Ç—ã —É—à–ª–∏ –≤ —Å–±—Ä–æ—Å.")
                self.current_attacker = self.current_defender
                self._choose_next_defender()
            else:
                self.log(f"–ò–≥—Ä–æ–∫ {self.current_defender+1} –ù–ï —Å–º–æ–≥ –æ—Ç–±–∏—Ç—å –∫–∞—Ä—Ç–æ–π {def_card}. –ë–µ—Ä—ë—Ç –æ–±–µ –∫–∞—Ä—Ç—ã.")
                self.players_hands[self.current_defender].append(atk_card)
                self.players_hands[self.current_defender].append(def_card)

        self._draw_cards_in_order()
        self._check_exit_players()

    def _choose_next_attacker(self):
        ap = sorted(list(self.active_players))
        if self.current_attacker in ap:
            idx = ap.index(self.current_attacker)
            idx_next = (idx + 1) % len(ap)
            self.current_attacker = ap[idx_next]
        else:
            self.current_attacker = ap[0]
        self._choose_next_defender()

    def _choose_next_defender(self):
        ap = sorted(list(self.active_players))
        if len(ap) < 2:
            self.current_defender = None
            return
        idx_atk = ap.index(self.current_attacker)
        idx_def = (idx_atk + 1) % len(ap)
        self.current_defender = ap[idx_def]

    def _draw_cards_in_order(self):
        if self.current_defender is None:
            return
        order = [self.current_attacker, self.current_defender]
        others = [p for p in range(self.num_players) if p not in order]
        full_order = order + others
        for pid in full_order:
            if pid in self.active_players:
                while len(self.players_hands[pid]) < 6 and self.deck.cards:
                    c = self.deck.draw_card()
                    self.players_hands[pid].append(c)

    def _check_exit_players(self):
        for p in list(self.active_players):
            if len(self.players_hands[p]) == 0:
                self.active_players.remove(p)
                self.log(f"–ò–≥—Ä–æ–∫ {p+1} —Å–±—Ä–æ—Å–∏–ª –≤—Å–µ –∫–∞—Ä—Ç—ã –∏ –≤—ã—Ö–æ–¥–∏—Ç.")

    def is_game_over(self):
        return len(self.active_players) < 2

    def get_winner_text(self):
        if len(self.active_players) == 0:
            return "–í—Å–µ –∏–≥—Ä–æ–∫–∏ —Å–±—Ä–æ—Å–∏–ª–∏ –∫–∞—Ä—Ç—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ! –í—Å–µ –ø–æ–±–µ–¥–∏–ª–∏!"
        elif len(self.active_players) == 1:
            loser = list(self.active_players)[0]
            return f"–ò–≥—Ä–æ–∫ {loser+1} –æ—Å—Ç–∞–ª—Å—è –æ–¥–∏–Ω (—Å –∫–∞—Ä—Ç–∞–º–∏) –∏ –ø—Ä–æ–∏–≥—Ä–∞–ª. –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–±–µ–¥–∏–ª–∏!"
        else:
            return "–ò–≥—Ä–∞ –µ—â—ë –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è."


#########################################################
#            –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –§–£–ù–ö–¶–ò–ò
#########################################################
session = None
game_state = "menu"

def switch_view(new_state):
    global game_state
    game_state = new_state

    # –ü–æ–ª—É—á–∞–µ–º –±–ª–æ–∫–∏ –∏–∑ DOM
    menu_div = document.getElementById("menu-container")
    game_div = document.getElementById("game-container")
    end_div = document.getElementById("end-container")

    # –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ
    menu_div.style.display = "none"
    game_div.style.display = "none"
    end_div.style.display = "none"

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π
    if new_state == "menu":
        menu_div.style.display = "block"
    elif new_state == "playing":
        game_div.style.display = "block"
    elif new_state == "end":
        end_div.style.display = "block"

def start_game():
    """
    –ß–∏—Ç–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ DOM,
    —Å–æ–∑–¥–∞—ë–º GameSession,
    –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —ç–∫—Ä–∞–Ω—É 'playing'.
    """
    global session
    mode_sel = document.getElementById("select_mode").value
    only_6 = document.getElementById("cb_6plus").checked
    jokers_on = document.getElementById("cb_jokers").checked
    n = int(document.getElementById("num_players").value)
    if n < 2: n = 2
    if n > 4: n = 4

    # –°–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏—é
    session = GameSession(mode_sel, n, only_6, jokers_on)

    # –ú–µ–Ω—è–µ–º —ç–∫—Ä–∞–Ω
    switch_view("playing")

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–∑—ã—Ä—å
    trump_span = document.getElementById("span_trump_suit")
    trump_span.innerHTML = session.rules.trump_suit

    render_log()

def render_log():
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∂—É—Ä–Ω–∞–ª —Ö–æ–¥–æ–≤ –≤ #log-area
    """
    global session
    log_div = document.getElementById("log-area")
    if session:
        log_div.innerHTML = session.get_log_text()
    else:
        log_div.innerHTML = "–ù–µ—Ç —Ç–µ–∫—É—â–µ–π –∏–≥—Ä—ã"

def do_next_round():
    """
    –°–æ–≤–µ—Ä—à–∞–µ–º –æ–¥–∏–Ω "—à–∞–≥" (–∞—Ç–∞–∫–∞/–∑–∞—â–∏—Ç–∞),
    –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã.
    """
    global session
    if not session:
        return
    session.do_round()

    if session.is_game_over():
        switch_view("end")
        end_msg = document.getElementById("end-message")
        end_msg.innerHTML = session.get_winner_text()
        render_log()
        return

    render_log()

def give_up():
    """
    –ü—Ä–µ—Ä—ã–≤–∞–µ–º –∏–≥—Ä—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é.
    """
    global session
    session = None
    switch_view("menu")

def return_menu():
    """
    –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è - –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é.
    """
    global session
    session = None
    switch_view("menu")


# –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–∫–∞–∂–µ–º –º–µ–Ω—é
switch_view("menu")

print("PyScript: –ò–≥—Ä–∞ '–î—É—Ä–∞–∫' –∑–∞–≥—Ä—É–∂–µ–Ω–∞.")
</py-script>

</body>
</html>
