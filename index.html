<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ—è –ò–≥—Ä–∞ (Brython) ‚Äî –ù–µ—Å–∫–æ–ª—å–∫–æ –ò–ò (3‚Äì4 –∏–≥—Ä–æ–∫–æ–≤), –ø–æ–ª–µ/–ª–æ–≥ –∑–µ–ª—ë–Ω—ã–µ, –∫–æ–∑—ã—Ä—å-¬´–∫–∞—Ä—Ç–∞¬ª</title>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Brython -->
  <script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>

  <!-- CSS —Å—Ç–∏–ª–∏ -->
  <style>
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    body {
      margin: 0; 
      padding: 0;
      font-family: Arial, sans-serif;
      background: #eee; /* –æ–±—â–∏–π —Ñ–æ–Ω —Å–∞–π—Ç–∞ */
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background: #3f51b5;
      color: white;
      width: 100%;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    .container {
      width: 600px;
      max-width: 90%;
      background: white; 
      margin: 1rem;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    button {
      background: #3f51b5;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
    }
    button:hover {
      background: #32408f;
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã, –∫—Ä–æ–º–µ –º–µ–Ω—é, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    #newgame-screen, #achievements-screen, #rules-screen,
    #settings-screen, #game-screen, #aifull-screen,
    #aifull-multi-screen {
      display: none;
    }

    /* –ó–µ–ª—ë–Ω–æ–µ –ø–æ–ª–µ */
    .game-field {
      background: #2e7d32; /* –∑–µ–ª—ë–Ω—ã–π —Ñ–æ–Ω */
      color: #fff;
      position: relative;
      min-height: 600px;
    }

    /* –ó–µ–ª—ë–Ω—ã–π –ª–æ–≥ (–≥–¥–µ —Ö–æ–¥—ã/–∫–∞—Ä—Ç—ã) */
    .green-log {
      background: #2e7d32;   /* —Ç–æ—Ç –∂–µ —Ü–≤–µ—Ç */
      color: #fff;
      border: 1px solid #4caf50;
      padding: 1rem;
      min-height: 150px; /* –ø—Ä–∏–º–µ—Ä –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ */
      overflow-y: auto; /* –µ—Å–ª–∏ –º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
      margin-bottom: 1rem;
      border-radius: 5px;
    }

    /* –ö–∞—Ä—Ç–æ—á–Ω—ã–π –¥–∏–∑–∞–π–Ω —É –≤—ã–±–æ—Ä–∞ –∫–∞—Ä—Ç */
    .card-list {
      margin: 0.5rem 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .card-item {
      background: #fff;
      color: #333;
      border: 2px solid #ccc;
      border-radius: 10px;
      width: 60px;
      height: 90px;
      margin: 0.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .card-item:hover {
      background: #f8f8f8;
    }

    /* –ü—Ä–∞–≤–∏–ª–∞ */
    .rules-block h3 {
      margin-top: 0.5rem;
      margin-bottom: 0.3rem;
    }
    .rules-block p {
      margin-top: 0.2rem;
      margin-bottom: 0.8rem;
      line-height: 1.4;
    }

    /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–∑—ã—Ä—å (—Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω –∫–∞–∫ –∫–∞—Ä—Ç–∞) */
    #trump-card {
      position: fixed;
      right: 30px;
      top: 150px;

      width: 60px;
      height: 90px;

      background: #fff;
      color: #333;
      border: 2px solid #333;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);

      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;

      z-index: 999;
    }
  </style>
</head>

<body onload="brython()">
<header>
  <h1>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –º–æ–µ–π –∏–≥—Ä—ã</h1>
</header>

<!-- –ö–æ–∑—ã—Ä—å (–≤ –≤–∏–¥–µ –∫–∞—Ä—Ç—ã), —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω —Å–ø—Ä–∞–≤–∞ -->
<div id="trump-card">?</div>

<!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
<div class="container" id="menu-screen">
  <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
  <button onclick="open_screen('newgame')">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button><br>
  <button onclick="open_screen('achievements')">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button><br>
  <button onclick="open_screen('rules')">–ü—Ä–∞–≤–∏–ª–∞</button><br>
  <button onclick="open_screen('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–ù–æ–≤–∞—è –∏–≥—Ä–∞" -->
<div class="container" id="newgame-screen">
  <h2>–ù–æ–≤–∞—è –∏–≥—Ä–∞</h2>
  <label>–†–µ–∂–∏–º –∏–≥—Ä—ã:</label><br>
  <select id="select_mode">
    <option value="classic">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</option>
    <option value="podkidnoi">–ü–æ–¥–∫–∏–¥–Ω–æ–π</option>
    <option value="perevodnoi">–ü–µ—Ä–µ–≤–æ–¥–Ω–æ–π</option>
    <option value="jokers">–° –¥–∂–æ–∫–µ—Ä–∞–º–∏</option>
    <option value="all">–í—Å–µ —Å—Ä–∞–∑—É</option>
  </select>
  <br><br>

  <label>
    <input type="checkbox" id="cb_jokers">
    –ò–≥—Ä–∞ —Å –¥–∂–æ–∫–µ—Ä–∞–º–∏
  </label>
  <br><br>

  <label>
    <input type="checkbox" id="cb_6plus">
    –ö–∞—Ä—Ç—ã —Ç–æ–ª—å–∫–æ 6..A
  </label>
  <br><br>

  <!-- AI –≤—ã–±–æ—Ä (2..4) -->
  <div id="ai-count-block" style="display:none; margin-bottom:1rem;">
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (1 —Ä–µ–∞–ª—å–Ω—ã–π + (N-1) –ò–ò), –æ—Ç 2 –¥–æ 4:</label><br>
    <input type="number" id="ai_players_count" value="2" min="2" max="4" />
  </div>

  <!-- –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä (2..10) -->
  <div id="multi-count-block" style="display:none; margin-bottom:1rem;">
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (2..10):</label><br>
    <input type="number" id="multi_players_count" value="4" min="2" max="10" />
    <br><br>
    <p>–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä: –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø –∫–æ–º–Ω–∞—Ç—ã:</p>
    <label>
      <input type="radio" name="room_type" value="link" checked>
      –ü–æ —Å—Å—ã–ª–∫–µ
    </label><br>
    <label>
      <input type="radio" name="room_type" value="open">
      –û—Ç–∫—Ä—ã—Ç–∞—è
    </label>
  </div>

  <label>–¢–∏–ø –∏–≥—Ä—ã:</label><br>
  <label>
    <input type="radio" name="game_type" value="ai" checked>
    –ò–≥—Ä–∞ —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é
  </label><br>
  <label>
    <input type="radio" name="game_type" value="multi">
    –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä
  </label>
  <br><br>

  <button onclick="start_new_game()">–ù–∞—á–∞—Ç—å</button>
  <button onclick="back_to_menu()">–û—Ç–º–µ–Ω–∞</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è" -->
<div class="container" id="achievements-screen">
  <h2>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
  <p>–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø–æ–∫–∞ –ø—É—Å—Ç.</p>
  <button onclick="back_to_menu()">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–ü—Ä–∞–≤–∏–ª–∞" -->
<div class="container" id="rules-screen">
  <h2>–ü—Ä–∞–≤–∏–ª–∞</h2>
  <div class="rules-block">
    <p>–í –∏–≥—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–ª–æ–¥–∞ –∏–∑ 7 –º–∞—Å—Ç–µ–π (‚ô†, ‚ô•, ‚ô¶, ‚ô£, ‚≠ê, üåô, ‚öú)
    –∏ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ 2 –æ—Å–æ–±—ã—Ö –¥–∂–æ–∫–µ—Ä–∞.
    –ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å –∫–∞—Ä—Ç–∞–º–∏ –æ—Ç 2 –¥–æ A, –∏–ª–∏ —Ç–æ–ª—å–∫–æ —Å 6..A, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫.</p>

    <h3>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –¥—É—Ä–∞–∫:</h3>
    <p>–û–±—ã—á–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: –∏–≥—Ä–æ–∫–∏ –∑–∞—â–∏—â–∞—é—Ç—Å—è –∏ –ø–æ–¥–∫–∏–¥—ã–≤–∞—é—Ç, –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–æ–≤.
    –ö–æ–∑—ã—Ä–Ω–∞—è –º–∞—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ. –î–∂–æ–∫–µ—Ä—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è,
    –µ—Å–ª–∏ –Ω–µ –æ—Ç–º–µ—á–µ–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</p>

    <h3>–ü–æ–¥–∫–∏–¥–Ω–æ–π –¥—É—Ä–∞–∫:</h3>
    <p>–†–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –ø–æ–¥–∫–∏–¥—ã–≤–∞—Ç—å –∫–∞—Ä—Ç—ã —Ç–æ–≥–æ –∂–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞, —á—Ç–æ —É–∂–µ –Ω–∞ —Å—Ç–æ–ª–µ.
    –î–∂–æ–∫–µ—Ä—ã (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã) –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç—ã.</p>

    <h3>–ü–µ—Ä–µ–≤–æ–¥–Ω–æ–π –¥—É—Ä–∞–∫:</h3>
    <p>–ï—Å–ª–∏ –æ—Ç–±–∏–≤–∞—é—â–∏–π—Å—è –º–æ–∂–µ—Ç –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Ö–æ–¥ (–µ—Å—Ç—å –∫–∞—Ä—Ç–∞ —Ç–æ–≥–æ –∂–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞),
    –æ–Ω –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –∞—Ç–∞–∫—É –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞. –ù–∞–ª–∏—á–∏–µ 7 –º–∞—Å—Ç–µ–π –∏ 2 –¥–∂–æ–∫–µ—Ä–æ–≤
    –¥–æ–±–∞–≤–ª—è–µ—Ç –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏.</p>

    <h3>–° –¥–∂–æ–∫–µ—Ä–∞–º–∏ (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º):</h3>
    <p>–í—Å–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞, –Ω–æ –¥–∂–æ–∫–µ—Ä—ã –∏–≥—Ä–∞—é—Ç –æ—Å–æ–±—É—é —Ä–æ–ª—å,
    –º–æ–≥—É—Ç –±–∏—Ç—å –ª—é–±—ã–µ –∫–∞—Ä—Ç—ã, –∏–ª–∏ –¥–∞–∂–µ —Å—á–∏—Ç–∞—Ç—å—Å—è –∫–æ–∑—ã—Ä—è–º–∏ (–≤ —É–ø—Ä–æ—â—ë–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏).
    –ö–æ–ª–æ–¥–∞ —Å–Ω–æ–≤–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å 2..A –∏–ª–∏ 6..A –ø–ª—é—Å 2 –¥–∂–æ–∫–µ—Ä–∞.</p>

    <h3>–í—Å–µ —Å—Ä–∞–∑—É:</h3>
    <p>–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –º–µ—Ö–∞–Ω–∏–∫–∏ –ø–æ–¥–∫–∏–¥–Ω–æ–≥–æ, –ø–µ—Ä–µ–≤–æ–¥–Ω–æ–≥–æ –∏ —Å –¥–∂–æ–∫–µ—Ä–∞–º–∏.
    –≠—Ç–æ —Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –º–Ω–æ–≥–æ –∫–∞—Ä—Ç (7 –º–∞—Å—Ç–µ–π, 2 –¥–∂–æ–∫–µ—Ä–∞),
    –º–æ–∂–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –∏ –ø–æ–¥–∫–∏–¥—ã–≤–∞—Ç—å. –û—á–µ–Ω—å —Ö–∞–æ—Ç–∏—á–Ω–æ –∏ –≤–µ—Å–µ–ª–æ!</p>
  </div>
  <button onclick="back_to_menu()">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" -->
<div class="container" id="settings-screen">
  <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
  <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç —Ç—É—Ç...</p>
  <button onclick="back_to_menu()">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–ò–≥—Ä–∞" (–¥–ª—è MULTI –∏–ª–∏ AI>2) -->
<div class="container" id="game-screen">
  <h2>–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!</h2>
  <p>–ü–æ–∫–∞ —Ç—É—Ç –Ω–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ –∏–≥—Ä—ã. –í—ã –≤—ã–±—Ä–∞–ª–∏:</p>
  <p><strong>–†–µ–∂–∏–º:</strong> <span id="chosen_mode"></span></p>
  <p><strong>–î–∂–æ–∫–µ—Ä—ã:</strong> <span id="chosen_jokers"></span></p>
  <p><strong>–¢–æ–ª—å–∫–æ 6..A:</strong> <span id="chosen_6plus"></span></p>
  <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤:</strong> <span id="chosen_players"></span></p>
  <p><strong>–¢–∏–ø –∏–≥—Ä—ã:</strong> <span id="chosen_type"></span> 
    ( <span id="chosen_room"></span> )
  </p>
  <button onclick="back_to_menu()">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "aifull-screen" ‚Äî –∑–µ–ª—ë–Ω–æ–µ –ø–æ–ª–µ (.game-field) –¥–ª—è 2 –∏–≥—Ä–æ–∫–æ–≤ -->
<div class="container game-field" id="aifull-screen">
  <h2>–ü–æ–ª–Ω–∞—è –ø–∞—Ä—Ç–∏—è —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é (2 –∏–≥—Ä–æ–∫–∞)</h2>
  <p>–ö—Ç–æ –ø–µ—Ä–≤—ã–π —Å–±—Ä–æ—Å–∏—Ç –∫–∞—Ä—Ç—ã ‚Äî —Ç–æ—Ç –≤—ã–∏–≥—Ä–∞–ª!</p>
  <p>–¢–µ–∫—É—â–∏–π —Ö–æ–¥: <span id="current-turn"></span></p>
  <div id="aifull-log" class="green-log"></div>
  <hr>
  <p><strong>–í–∞—à–∏ –∫–∞—Ä—Ç—ã:</strong></p>
  <ul class="card-list" id="user-cards-list"></ul>
  <button onclick="restart_aifull()">–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  <button onclick="back_to_menu()">–í—ã–π—Ç–∏ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "aifull-multi-screen" (3..4 –∏–≥—Ä–æ–∫–æ–≤) - —Ç–æ–∂–µ –∑–µ–ª—ë–Ω–æ–µ –ø–æ–ª–µ, 
     –ª–æ–≥ —Ç–æ–∂–µ –∑–µ–ª—ë–Ω—ã–π -->
<div class="container game-field" id="aifull-multi-screen">
  <h2>–ü–æ–ª–Ω–∞—è –ø–∞—Ä—Ç–∏—è —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ò–ò (3..4 –∏–≥—Ä–æ–∫–æ–≤)</h2>
  <p>–ö—Ç–æ –ø–µ—Ä–≤—ã–π —Å–±—Ä–æ—Å–∏—Ç –∫–∞—Ä—Ç—ã ‚Äî —Ç–æ—Ç –≤—ã–∏–≥—Ä–∞–ª!<br>
     –¢–µ–∫—É—â–∏–π —Ö–æ–¥: <span id="multi-turn"></span></p>
  <div id="aifull-multi-log" class="green-log"></div>
  <hr>
  <p><strong>–í–∞—à–∏ –∫–∞—Ä—Ç—ã:</strong></p>
  <ul class="card-list" id="user-multi-cards"></ul>
  <button onclick="restart_aifull_multi()">–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  <button onclick="back_to_menu()">–í—ã–π—Ç–∏ –≤ –º–µ–Ω—é</button>
</div>

<script type="text/python">
############################################
#        –ò–º–ø–æ—Ä—Ç –∏–∑ browser, random
############################################
from browser import document, window
import random

############################################
#         –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –≠–ö–†–ê–ù–û–í
############################################
def switch_view(show_id):
    screens = [
        "menu-screen","newgame-screen","achievements-screen","rules-screen",
        "settings-screen","game-screen","aifull-screen","aifull-multi-screen"
    ]
    for s in screens:
        document[s].style.display = "none"
    document[show_id].style.display = "block"

def back_to_menu():
    switch_view("menu-screen")

def open_screen(name):
    switch_view(name+"-screen")

def on_game_type_change(ev):
    check_game_type()

def check_game_type():
    """
    –ï—Å–ª–∏ game_type=ai => –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ai-count-block,
    –∏–Ω–∞—á–µ multi-count-block.
    """
    radio_list = document.select("[name='game_type']")
    chosen = "ai"
    for r in radio_list:
        if r.checked:
            chosen = r.value
            break
    ai_block = document["ai-count-block"]
    multi_block = document["multi-count-block"]
    if chosen=="ai":
        ai_block.style.display = "block"
        multi_block.style.display = "none"
    else:
        ai_block.style.display = "none"
        multi_block.style.display = "block"

def init():
    for r in document.select("[name='game_type']"):
        r.bind("change", on_game_type_change)
    check_game_type()

init()

def rank_index(rank):
    order = ["2","3","4","5","6","7","8","9","10","J","Q","K","A"]
    return order.index(rank) if rank in order else -1

def can_defend(card_def, card_atk, trump_suit):
    rd, sd, jd = card_def
    ra, sa, ja = card_atk
    if jd:
        if ja: return False
        return True
    if ja:
        return False

    is_trump_def = (sd == trump_suit)
    is_trump_atk = (sa == trump_suit)

    if is_trump_def and not is_trump_atk:
        return True
    if not is_trump_def and is_trump_atk:
        return False

    if sd == sa:
        return rank_index(rd)>rank_index(ra)
    return False

def draw_until_6(hand, deck):
    while len(hand)<6 and len(deck)>0:
        hand.append(deck.pop(0))
    return hand

def create_deck(only_6plus, with_jokers):
    suits=["‚ô†","‚ô•","‚ô¶","‚ô£","‚≠ê","üåô","‚öú"]
    ranks_all=[str(n) for n in range(2,11)] + ["J","Q","K","A"]
    if only_6plus:
        ranks_all=[r for r in ranks_all if r not in ["2","3","4","5"]]
    d=[]
    for s in suits:
        for r in ranks_all:
            d.append((r,s,False))
    if with_jokers:
        d.append(("Joker-3","JokerSuit",True))
        d.append(("Joker-4","JokerSuit",True))
    return d

###################### 2 –ò–ì–†–û–ö–ê ######################
deck = []
AI_cards = []
user_cards = []
trump_suit = ""
current_attacker = "AI"
log_lines = []
allow_user_click = False

def start_aifull_game(only_6plus, with_jokers):
    global deck, AI_cards, user_cards, trump_suit, current_attacker, log_lines, allow_user_click
    deck=create_deck(only_6plus, with_jokers)
    random.shuffle(deck)

    AI_cards=deck[:6]
    user_cards=deck[6:12]
    del deck[:12]

    suits=["‚ô†","‚ô•","‚ô¶","‚ô£","‚≠ê","üåô","‚öú"]
    trump_suit = random.choice(suits)

    current_attacker="AI"
    log_lines=[f"–ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Ç–∏—é (2 –∏–≥—Ä–æ–∫–∞). –ö–æ–∑—ã—Ä—å: {trump_suit}"]
    allow_user_click=False

    # –ü–∏—à–µ–º –∫–æ–∑—ã—Ä—å –≤ #trump-card
    document["trump-card"].innerHTML = f"<div style='font-size:1.5rem;'>{trump_suit}</div>"

    ai_attack()
    switch_view("aifull-screen")
    update_aifull_ui()

def ai_attack():
    global AI_cards, log_lines, allow_user_click
    if len(AI_cards)==0:
        return
    atk_card=AI_cards[0]
    log_lines.append(f"(AI –∞—Ç–∞–∫—É–µ—Ç) => {atk_card}")
    allow_user_click=True

def update_aifull_ui():
    aifull_log_div = document["aifull-log"]
    aifull_log_div.innerHTML="<pre>"+"\n".join(log_lines)+"</pre>"

    turn_text="AI" if current_attacker=="AI" else "–í—ã"
    document["current-turn"].textContent=turn_text

    ul=document["user-cards-list"]
    ul.clear()
    for i,c in enumerate(user_cards):
        li=document.createElement("li")
        li.classList.add("card-item")
        li.innerHTML=str(c)
        def on_click(ev, idx=i):
            handle_card_click(idx)
        li.bind("click", on_click)
        ul.appendChild(li)

    if len(AI_cards)==0:
        log_lines.append("AI —Å–±—Ä–æ—Å–∏–ª –≤—Å–µ –∫–∞—Ä—Ç—ã ‚Äî AI –≤—ã–∏–≥—Ä–∞–ª!")
        aifull_log_div.innerHTML="<pre>"+"\n".join(log_lines)+"</pre>"
        return
    if len(user_cards)==0:
        log_lines.append("–í—ã —Å–±—Ä–æ—Å–∏–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç—ã ‚Äî –≤—ã –ø–æ–±–µ–¥–∏–ª–∏!")
        aifull_log_div.innerHTML="<pre>"+"\n".join(log_lines)+"</pre>"
        return

def handle_card_click(idx):
    global deck, AI_cards, user_cards, trump_suit, current_attacker, log_lines, allow_user_click
    if not allow_user_click:
        return
    if idx<0 or idx>=len(user_cards):
        return

    c=user_cards[idx]
    if current_attacker=="AI":
        atk_card=AI_cards[0]
        log_lines.append(f"–í—ã –æ—Ç–±–∏–≤–∞–µ—Ç–µ—Å—å {c} –æ—Ç {atk_card}...")
        if can_defend(c,atk_card,trump_suit):
            log_lines.append("–£—Å–ø–µ—à–Ω–∞—è –∑–∞—â–∏—Ç–∞!")
            AI_cards.pop(0)
            user_cards.pop(idx)
            current_attacker="USER"
        else:
            log_lines.append("–ù–µ –æ—Ç–±–∏–ª–∏—Å—å, –≤—ã –±–µ—Ä—ë—Ç–µ –∫–∞—Ä—Ç—É AI.")
            user_cards.append(atk_card)
            AI_cards.pop(0)
        allow_user_click=False

        if current_attacker=="AI":
            AI_cards=draw_until_6(AI_cards,deck)
            user_cards=draw_until_6(user_cards,deck)
            if len(AI_cards)>0:
                ai_attack()
        else:
            user_cards=draw_until_6(user_cards,deck)
            AI_cards=draw_until_6(AI_cards,deck)
            allow_user_click=True
            log_lines.append("–¢–µ–ø–µ—Ä—å –≤–∞—à —Ö–æ–¥, –∞—Ç–∞–∫—É–π—Ç–µ.")
        update_aifull_ui()
    else:
        log_lines.append(f"–í—ã –∞—Ç–∞–∫—É–µ—Ç–µ {c}...")
        user_cards.pop(idx)
        def_idx=None
        for i,cardAi in enumerate(AI_cards):
            if can_defend(cardAi,c,trump_suit):
                def_idx=i
                break
        if def_idx is not None:
            def_card=AI_cards[def_idx]
            log_lines.append(f"AI –æ—Ç–±–∏–≤–∞–µ—Ç—Å—è {def_card}!")
            AI_cards.pop(def_idx)
            current_attacker="AI"
            allow_user_click=False
        else:
            log_lines.append("AI –Ω–µ –æ—Ç–±–∏–ª—Å—è –∏ –±–µ—Ä—ë—Ç –≤–∞—à—É –∫–∞—Ä—Ç—É.")
            AI_cards.append(c)
        if current_attacker=="AI":
            AI_cards=draw_until_6(AI_cards,deck)
            user_cards=draw_until_6(user_cards,deck)
            if len(AI_cards)>0:
                ai_attack()
        else:
            user_cards=draw_until_6(user_cards,deck)
            AI_cards=draw_until_6(AI_cards,deck)
        update_aifull_ui()

def restart_aifull():
    jokers_checked=document["cb_jokers"].checked
    sixplus_checked=document["cb_6plus"].checked
    start_aifull_game(sixplus_checked,jokers_checked)

################## 3..4 –ò–ì–†–û–ö–û–í (aifull-multi) ##################
n_players=3
hands=[]
deck_multi=[]
trump_multi=""
cur_attacker=0
log_multi=[]
allow_click_multi=False

def start_aifull_multi_game(only_6plus, with_jokers, total_players):
    global n_players, hands, deck_multi, trump_multi, cur_attacker, log_multi, allow_click_multi
    n_players=total_players
    deck_multi=create_deck(only_6plus, with_jokers)
    random.shuffle(deck_multi)

    hands=[]
    offset=0
    for i in range(n_players):
        h=deck_multi[offset:offset+6]
        offset+=6
        hands.append(h)
    deck_multi=deck_multi[offset:]

    suits=["‚ô†","‚ô•","‚ô¶","‚ô£","‚≠ê","üåô","‚öú"]
    trump_multi=random.choice(suits)
    document["trump-card"].innerHTML = f"<div style='font-size:1.5rem;'>{trump_multi}</div>"

    cur_attacker=1
    log_multi=[f"–ù–∞—á–∏–Ω–∞–µ–º (1—á–µ–ª + {n_players-1} –ò–ò). –ö–æ–∑—ã—Ä—å: {trump_multi}"]
    allow_click_multi=False

    ai_multi_attack(cur_attacker)
    update_aifull_multi_ui()
    switch_view("aifull-multi-screen")

def update_aifull_multi_ui():
    global log_multi, cur_attacker, hands
    document["aifull-multi-log"].innerHTML="<pre>"+"\n".join(log_multi)+"</pre>"
    turn_text=f"AI[{cur_attacker}]" if cur_attacker!=0 else "–í—ã"
    document["multi-turn"].textContent=turn_text

    ul=document["user-multi-cards"]
    ul.clear()
    for i,c in enumerate(hands[0]):
        li=document.createElement("li")
        li.classList.add("card-item")
        li.innerHTML=str(c)
        def on_click(ev, idx=i):
            handle_multi_card_click(idx)
        li.bind("click", on_click)
        ul.appendChild(li)

    for i in range(n_players):
        if len(hands[i])==0:
            if i==0:
                log_multi.append("–í—ã —Å–±—Ä–æ—Å–∏–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç—ã ‚Äî –ü–æ–±–µ–¥–∞!")
            else:
                log_multi.append(f"AI[{i}] —Å–±—Ä–æ—Å–∏–ª –≤—Å–µ –∫–∞—Ä—Ç—ã ‚Äî –û–Ω –≤—ã–∏–≥—Ä–∞–ª!")
            log_multi.append("–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
            document["aifull-multi-log"].innerHTML="<pre>"+"\n".join(log_multi)+"</pre>"
            return

def handle_multi_card_click(idx):
    global allow_click_multi,hands,cur_attacker,deck_multi,log_multi,trump_multi,n_players
    if not allow_click_multi:return
    if idx<0 or idx>=len(hands[0]):return

    selected_card=hands[0][idx]
    defender=(cur_attacker+1)%n_players

    if cur_attacker==0:
        log_multi.append(f"–í—ã –∞—Ç–∞–∫—É–µ—Ç–µ {selected_card}...")
        hands[0].pop(idx)
        def_card=None
        def_idx=None
        for i,c in enumerate(hands[defender]):
            if can_defend(c,selected_card,trump_multi):
                def_card=c
                def_idx=i
                break
        if def_card:
            log_multi.append(f"AI[{defender}] –æ—Ç–±–∏–≤–∞–µ—Ç—Å—è {def_card}. –£—Å–ø–µ—à–Ω–æ!")
            hands[defender].pop(def_idx)
            cur_attacker=defender
            allow_click_multi=False
            do_multi_draw()
            ai_multi_attack(cur_attacker)
        else:
            log_multi.append(f"AI[{defender}] –ù–ï –æ—Ç–±–∏–ª—Å—è, –±–µ—Ä—ë—Ç –≤–∞—à—É –∫–∞—Ä—Ç—É.")
            hands[defender].append(selected_card)
            do_multi_draw()
        update_aifull_multi_ui()
    else:
        if defender==0:
            atk_card=hands[cur_attacker][0]
            log_multi.append(f"–í—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –æ—Ç–±–∏—Ç—å—Å—è {selected_card} –æ—Ç {atk_card}...")
            if can_defend(selected_card,atk_card,trump_multi):
                log_multi.append("–£—Å–ø–µ—à–Ω–æ –æ—Ç–±–∏–ª–∏—Å—å!")
                hands[cur_attacker].pop(0)
                hands[0].pop(idx)
                cur_attacker=0
                allow_click_multi=True
                log_multi.append("–¢–µ–ø–µ—Ä—å –≤–∞—à —Ö–æ–¥ (–∞—Ç–∞–∫—É–π—Ç–µ).")
            else:
                log_multi.append("–ù–µ –æ—Ç–±–∏–ª–∏—Å—å, –≤—ã –±–µ—Ä—ë—Ç–µ –∫–∞—Ä—Ç—É AI.")
                hands[0].append(atk_card)
                hands[cur_attacker].pop(0)
                allow_click_multi=False
            do_multi_draw()
            if cur_attacker!=0:
                ai_multi_attack(cur_attacker)
            update_aifull_multi_ui()
        else:
            # AI vs AI
            pass

def ai_multi_attack(att_idx):
    global hands, deck_multi, log_multi, allow_click_multi, cur_attacker, n_players, trump_multi
    if len(hands[att_idx])==0:return
    atk_card=hands[att_idx][0]
    df=(att_idx+1)%n_players
    log_multi.append(f"AI[{att_idx}] –∞—Ç–∞–∫—É–µ—Ç {atk_card} -> defender= player[{df}]")

    if df==0:
        allow_click_multi=True
    else:
        def_i=None
        for i,c in enumerate(hands[df]):
            if can_defend(c,atk_card,trump_multi):
                def_i=i
                break
        if def_i is not None:
            def_card=hands[df][def_i]
            log_multi.append(f"AI[{df}] –æ—Ç–±–∏–≤–∞–µ—Ç—Å—è {def_card} ‚Äî —É—Å–ø–µ—à–Ω–æ!")
            hands[df].pop(def_i)
            hands[att_idx].pop(0)
            cur_attacker=df
        else:
            log_multi.append(f"AI[{df}] –Ω–µ –æ—Ç–±–∏–ª—Å—è, –±–µ—Ä—ë—Ç {atk_card}")
            hands[df].append(atk_card)
            hands[att_idx].pop(0)
        do_multi_draw()
        if cur_attacker!=df:
            if len(hands[att_idx])>0:
                ai_multi_attack(att_idx)
        else:
            if cur_attacker==0:
                allow_click_multi=True
                log_multi.append("–¢–µ–ø–µ—Ä—å –≤–∞—à —Ö–æ–¥ (–≤—ã –∞—Ç–∞–∫—É—é—â–∏–π).")
            else:
                ai_multi_attack(cur_attacker)

def do_multi_draw():
    global hands, deck_multi, cur_attacker, n_players
    order=[cur_attacker]
    for i in range(n_players):
        if i!=cur_attacker:
            order.append(i)
    for idx in order:
        hands[idx]=draw_until_6(hands[idx], deck_multi)

def restart_aifull_multi():
    jokers_checked=document["cb_jokers"].checked
    sixplus_checked=document["cb_6plus"].checked
    ai_str=document["ai_players_count"].value
    try:
        ai_num=int(ai_str)
    except:
        ai_num=3
    if ai_num<3: ai_num=3
    if ai_num>4: ai_num=4
    start_aifull_multi_game(sixplus_checked, jokers_checked, ai_num)

############################ –ó–ê–ü–£–°–ö NEW GAME ###########################
def start_new_game():
    mode_value=document["select_mode"].value
    jokers_checked=document["cb_jokers"].checked
    sixplus_checked=document["cb_6plus"].checked

    radio_list=document.select("[name='game_type']")
    game_type="ai"
    for r in radio_list:
        if r.checked:
            game_type=r.value
            break

    if game_type=="ai":
        ai_count_str=document["ai_players_count"].value
        try:
            ai_count=int(ai_count_str)
        except:
            ai_count=2
        if ai_count<2: ai_count=2
        if ai_count>4: ai_count=4

        if ai_count==2:
            start_aifull_game(sixplus_checked,jokers_checked)
        else:
            start_aifull_multi(sixplus_checked,jokers_checked,ai_count)
    else:
        multi_count_str=document["multi_players_count"].value
        try:
            multi_count=int(multi_count_str)
        except:
            multi_count=4
        if multi_count<2: multi_count=2
        if multi_count>10: multi_count=10

        rlist=document.select("[name='room_type']")
        rt="link"
        for rr in rlist:
            if rr.checked:
                rt=rr.value
                break

        document["chosen_mode"].textContent=mode_value
        document["chosen_jokers"].textContent="–î–∞" if jokers_checked else "–ù–µ—Ç"
        document["chosen_6plus"].textContent="–î–∞" if sixplus_checked else "–ù–µ—Ç"
        document["chosen_players"].textContent=str(multi_count)
        document["chosen_type"].textContent="–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä"
        if rt=="link":
            rtxt="–ü–æ —Å—Å—ã–ª–∫–µ"
        else:
            rtxt="–û—Ç–∫—Ä—ã—Ç–∞—è"
        document["chosen_room"].textContent=rtxt

        switch_view("game-screen")



############################################
# 1) –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: —Å–≤—è–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ —Å window (—á—Ç–æ–±—ã onclick –≤–∏–¥–µ–ª –∏—Ö)
from browser import window

window.open_screen = open_screen
window.back_to_menu = back_to_menu
window.start_new_game = start_new_game
window.restart_aifull = restart_aifull
window.restart_aifull_multi = restart_aifull_multi
############################################

</script>
</body>
</html>
